<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuk Rush - DJ Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700;900&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Noto Sans Sinhala', sans-serif; touch-action: none; user-select: none; }
        .font-tech { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        
        #mute-btn {
            position: absolute; top: 10px; right: 10px; z-index: 100;
            background: rgba(255, 255, 255, 0.2); border: 2px solid white;
            color: white; padding: 8px; border-radius: 50%; font-size: 1.2rem;
            cursor: pointer; backdrop-filter: blur(5px);
        }

        #social-btn-corner {
            position: absolute; top: 60px; right: 10px; z-index: 90;
            background: #1877F2; color: white; padding: 5px 10px;
            border-radius: 20px; font-weight: bold; font-size: 0.7rem;
            text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 5px;
        }

        .mirror-frame {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 160px; height: 70px;
            background: rgba(0, 0, 0, 0); 
            border: 3px solid #888; border-radius: 12px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            z-index: 50; overflow: hidden;
        }
        .mirror-glass {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%);
            pointer-events: none;
        }
        
        #warning-container {
            position: absolute; top: 90px; right: 0; 
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
            pointer-events: none; overflow: hidden; padding-right: 10px; z-index: 40;
        }
        .bus-alert {
            background: linear-gradient(90deg, #800080, #ff00ff);
            color: white; padding: 10px 20px; border-radius: 8px 0 0 8px;
            font-weight: 900; text-transform: uppercase;
            border-left: 5px solid #ffff00;
            box-shadow: -5px 5px 15px rgba(0,0,0,0.5);
            transform: translateX(100%);
            animation: slideIn 0.3s forwards, pulseWarn 0.5s infinite alternate;
        }
        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes pulseWarn { from { text-shadow: 0 0 5px white; } to { text-shadow: 0 0 20px yellow; } }

        #shout-container { position: absolute; inset: 0; pointer-events: none; z-index: 45; overflow: hidden; }
        .shout-bubble {
            position: absolute; background: rgba(255, 255, 255, 0.95); color: black;
            padding: 8px 12px; border-radius: 12px; border: 3px solid black;
            font-weight: 900; font-size: 0.9rem; box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            animation: popUp 0.3s ease-out; white-space: nowrap; max-width: 150px;
            text-align: center; white-space: normal;
        }
        .shout-player {
            background: #FFEB3B; color: #D50000; border-color: #D50000;
            left: 50%; bottom: 40%; transform: translateX(-50%);
            font-size: 1.2rem; text-shadow: 1px 1px 0px white; z-index: 60; max-width: none;
        }
        @keyframes popUp { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .leaderboard-row:nth-child(1) { color: #FFD700; font-weight: 900; border: 1px solid gold; } 
        .leaderboard-row:nth-child(2) { color: #C0C0C0; font-weight: 800; } 
        .leaderboard-row:nth-child(3) { color: #CD7F32; font-weight: 800; }
        .shake { animation: shake 0.5s; border-color: red !important; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .pickup-anim {
            position: absolute; color: #00FF00; font-weight: 900; font-size: 1.5rem;
            animation: floatUp 0.8s forwards; pointer-events: none; z-index: 70;
            text-shadow: 0 0 5px black;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        #time-indicator { position: absolute; top: 10px; left: 10px; z-index: 60; font-size: 2rem; }

        .license-card {
            background: linear-gradient(180deg, #f3f4f6 0%, #d1d5db 100%);
            border: 4px solid #1f2937; border-radius: 16px; position: relative; overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .license-header { background: #111827; color: white; padding: 10px; text-align: center; border-bottom: 4px solid #f59e0b; }
        .stamp {
            position: absolute; right: 10px; bottom: 10px; border: 3px solid #ef4444; color: #ef4444;
            padding: 5px; font-weight: 900; transform: rotate(-15deg); opacity: 0.7; font-family: 'Orbitron', sans-serif;
        }

        /* Loading Indicator */
        #loading-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: yellow; padding: 5px 15px;
            border-radius: 20px; font-size: 12px; z-index: 1000; display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="game-container" class="absolute inset-0 z-0"></div>
    <div id="shout-container"></div>
    <div id="time-indicator">üåô</div>
    <div id="loading-msg">üéµ ‡∑É‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä ‡∂Ω‡∑ù‡∂©‡∑ä ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è...</div>
    
    <button id="mute-btn" onclick="toggleSound()">üîä</button>
    <a href="https://www.facebook.com/share/1DLZicSmUT/" target="_blank" id="social-btn-corner">
        <span>üëç</span> Follow Page
    </a>

    <div id="game-ui" class="absolute inset-0 z-10 hidden flex-col justify-between p-4 pointer-events-none">
        <div class="flex justify-between items-start w-full pointer-events-auto mt-1 relative">
            <div class="bg-gray-800/80 backdrop-blur border-l-4 border-yellow-500 px-4 py-2 rounded-r-xl shadow-lg">
                <p class="text-[10px] text-gray-400 font-bold uppercase">SCORE</p>
                <p id="score-display" class="text-2xl font-black font-tech text-yellow-400">0</p>
            </div>
            <div class="mirror-frame" id="mirror-box">
                <div class="mirror-glass"></div>
                <div id="mirror-alert" class="absolute inset-0 border-4 border-red-600 hidden animate-pulse"></div>
            </div>
            <div class="bg-gray-800/80 backdrop-blur border-r-4 border-blue-500 px-4 py-2 rounded-l-xl shadow-lg">
                <p class="text-[10px] text-gray-400 font-bold uppercase text-right">PICKUPS</p>
                <p id="passenger-count" class="text-2xl font-black text-right font-tech text-blue-400">0</p>
            </div>
        </div>
        <div id="warning-container"></div>
    </div>

    <div id="start-screen" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-black/95 p-4 text-center overflow-y-auto">
        <h1 class="text-5xl font-black text-yellow-400 mb-2 italic tracking-tighter font-tech" style="text-shadow: 0 0 25px orange;">
            TUK<br><span class="text-white">RUSH</span>
        </h1>
        
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 max-w-sm w-full mb-4 shadow-2xl text-left">
            <h3 class="text-white font-bold text-lg mb-2 border-b border-gray-600 pb-2">üö¶ Update Notes:</h3>
            <ul class="rules-list pl-1 text-sm text-gray-300">
                <li>üéß <b>Music:</b> 'audio.mp3' ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂Ø‡∑è‡∂±‡∑ä‡∂±.</li>
                <li>‚úçÔ∏è <b>Custom Wadan:</b> Garage ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂î‡∂∫‡∑è‡∂ú‡∑ô‡∂∏ ‡∑Ä‡∂Ø‡∂±‡∂ö‡∑ä ‡∂Ø‡∑è‡∂ú‡∂±‡∑ä‡∂±!</li>
                <li>üîä <b>Sound:</b> ‡∂Ø‡∂ö‡∑î‡∂´‡∑î ‡∂¥‡∑ê‡∂≠‡∑ä‡∂≠‡∑ö ‡∂ã‡∂©‡∑í‡∂±‡∑ä Sound Off ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂¥‡∑î‡∂Ω‡∑î‡∑Ä‡∂±‡∑ä.</li>
            </ul>
        </div>
        
        <div class="w-full max-w-xs space-y-3">
            <p id="welcome-msg" class="text-green-400 text-sm font-bold hidden">‡∂Ü‡∂∫‡∑ö ‡∂Ü‡∑Ä‡∂Ø ‡∂∏‡∂†‡∂Ç? ‡∂ë‡∑Ö!</p>
            <div class="relative">
                <input type="text" id="player-name" placeholder="‡∂î‡∂∫‡∑è‡∂ú‡∑ö ‡∂±‡∂∏" maxlength="12"
                       class="w-full px-4 py-3 rounded-xl bg-gray-900 border-2 border-gray-600 text-white text-center font-bold outline-none focus:border-yellow-500 transition-colors">
                <p id="name-error" class="text-red-500 text-xs font-bold mt-1 hidden">‡∂±‡∂∏ ‡∂¥‡∑è‡∑Ä‡∑í‡∂†‡∑ä‡∂†‡∑í ‡∂ö‡∂ª‡∂Ω‡∑è! ‡∂∏‡∑ö‡∂ö ‡∂ú‡∂±‡∑ä‡∂±:</p>
                <button id="suggestion-btn" class="hidden bg-blue-600 text-white text-xs px-2 py-1 rounded mt-1 mx-auto">Suggested Name</button>
            </div>
            
            <button id="start-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black text-xl py-4 rounded-xl shadow-lg transform active:scale-95 transition font-tech flex justify-center items-center gap-2">
                <span id="btn-text">START RACE ‚ñ∂</span>
                <span id="btn-loader" class="hidden w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></span>
            </button>
            
            <button onclick="toggleGarage()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                <span>üõí</span> Garage / Shop
            </button>

            <a href="https://www.facebook.com/share/1DLZicSmUT/" target="_blank" class="block w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg text-sm flex items-center justify-center gap-2 no-underline">
                <span>üëç</span> Follow Us on Facebook
            </a>
        </div>
    </div>

    <div id="garage-modal" class="hidden absolute inset-0 z-40 bg-black/95 flex flex-col items-center justify-center p-6 overflow-y-auto">
        <h2 class="text-3xl text-yellow-400 font-black mb-2 font-tech">GARAGE</h2>
        <p class="text-gray-400 mb-4">Balance: <span id="total-coins" class="text-white font-bold text-xl">0</span> Passengers</p>
        
        <div class="w-full max-w-md space-y-4">
            <div class="bg-gray-800 p-3 rounded-xl border border-yellow-600/50">
                <h3 class="text-yellow-400 font-bold mb-2 text-sm uppercase">‚úçÔ∏è Custom Wadan (Cost: 300)</h3>
                <div class="flex gap-2">
                    <input type="text" id="custom-wadan-input" placeholder="Enter text (Max 10 chars)" maxlength="10" 
                           class="flex-1 px-3 py-2 bg-gray-900 border border-gray-600 rounded text-white text-sm">
                    <button onclick="buyCustomWadan()" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold px-4 py-2 rounded text-sm">BUY</button>
                </div>
            </div>

            <div>
                <h3 class="text-white font-bold mb-2 border-b border-gray-700">üìú Standard Stickers</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectWadan('‡∑Ä‡∂Ø‡∂±‡∑ä ‡∂±‡∑ë', 0)" class="p-2 bg-gray-800 rounded border border-gray-600 text-xs text-white">‡∑Ä‡∂Ø‡∂±‡∑ä ‡∂±‡∑ë (Free)</button>
                    <button onclick="selectWadan('‡∑É‡∑î‡∂Ø‡∑ä‡∂Ø', 20)" class="p-2 bg-gray-800 rounded border border-gray-600 text-xs text-white">‡∑É‡∑î‡∂Ø‡∑ä‡∂Ø (20)</button>
                    <button onclick="selectWadan('‡∑É‡∂∫‡∑í‡∂Ω‡∂±‡∑ä‡∑É‡∂ª‡∑ä', 50)" class="p-2 bg-gray-800 rounded border border-gray-600 text-xs text-white">‡∑É‡∂∫‡∑í‡∂Ω‡∂±‡∑ä‡∑É‡∂ª‡∑ä (50)</button>
                    <button onclick="selectWadan('‡∑Ñ‡∑í‡∂≠‡∑î‡∂∏‡∂≠‡∑ö', 100)" class="p-2 bg-gray-800 rounded border border-gray-600 text-xs text-white">‡∑Ñ‡∑í‡∂≠‡∑î‡∂∏‡∂≠‡∑ö (100)</button>
                </div>
            </div>

            <div>
                <h3 class="text-white font-bold mb-2 border-b border-gray-700">üé® Paint Job</h3>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="selectColor(0xDC2626, 0)" class="h-12 bg-red-600 rounded border-2 border-white"></button>
                    <button onclick="selectColor(0x2563EB, 50)" class="h-12 bg-blue-600 rounded border-2 border-gray-600 relative"><span class="absolute text-[8px] bg-black text-white px-1 bottom-0 right-0">50</span></button>
                    <button onclick="selectColor(0x10B981, 100)" class="h-12 bg-green-500 rounded border-2 border-gray-600 relative"><span class="absolute text-[8px] bg-black text-white px-1 bottom-0 right-0">100</span></button>
                    <button onclick="selectColor(0xFFD700, 200)" class="h-12 bg-yellow-500 rounded border-2 border-gray-600 relative"><span class="absolute text-[8px] bg-black text-white px-1 bottom-0 right-0">200</span></button>
                </div>
            </div>
        </div>
        <button onclick="toggleGarage()" class="bg-gray-600 px-8 py-3 rounded-xl font-bold text-white w-full max-w-md mt-4">CLOSE ‚ùå</button>
    </div>

    <div id="game-over-screen" class="hidden absolute inset-0 z-30 flex flex-col bg-black/95 backdrop-blur-md p-4 overflow-hidden">
        <div class="flex-grow flex flex-col items-center justify-center overflow-y-auto py-4">
            <h2 class="text-4xl font-black text-red-600 mb-4 italic font-tech animate-pulse">WASTED!</h2>
            
            <div class="license-card w-full max-w-sm mb-6 text-black">
                <div class="license-header">
                    <h3 class="text-lg font-bold font-tech text-yellow-500">TUK RUSH DRIVER LICENSE</h3>
                    <p class="text-[10px] text-gray-400">DEPARTMENT OF MOTOR TRAFFIC - SRI LANKA</p>
                </div>
                <div class="p-4 grid grid-cols-3 gap-2">
                    <div class="col-span-1 bg-gray-300 h-24 rounded flex items-center justify-center border border-gray-400">
                        <span class="text-3xl">üë§</span>
                    </div>
                    <div class="col-span-2 space-y-1">
                        <div class="flex justify-between border-b border-gray-400 pb-1">
                            <span class="text-xs font-bold text-gray-600">NAME:</span>
                            <span id="card-name" class="text-sm font-bold uppercase">---</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-400 pb-1">
                            <span class="text-xs font-bold text-gray-600">STICKER:</span>
                            <span id="card-wadan" class="text-sm font-bold text-red-600">---</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-400 pb-1">
                            <span class="text-xs font-bold text-gray-600">SCORE:</span>
                            <span id="final-score" class="text-sm font-black text-blue-800">0</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-200 p-2 text-center border-t border-gray-400">
                    <p class="text-[10px] text-gray-500 uppercase">Class Of Vehicle</p>
                    <h3 id="funny-badge" class="text-lg font-black text-black">---</h3>
                </div>
                <div class="stamp">EXPIRED</div>
            </div>

            <p id="upload-status" class="text-xs text-blue-400 mt-1 mb-4">Checking Database...</p>

            <div class="bg-gray-800 w-full max-w-sm rounded-xl p-3 mb-2 border border-gray-700 shrink-0">
                <h4 class="text-yellow-400 font-bold text-sm uppercase mb-2 border-b border-gray-600 pb-1">üèÜ Top Legends</h4>
                <div id="leaderboard-list" class="flex flex-col gap-1 text-sm max-h-32 overflow-y-auto">
                    <p class="text-gray-500 text-xs">Loading...</p>
                </div>
            </div>
        </div>

        <div class="w-full max-w-sm mx-auto flex flex-col gap-2 pb-4 pt-2 bg-black/0 z-50">
            <a href="https://www.facebook.com/share/1DLZicSmUT/" target="_blank" class="bg-blue-700 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 no-underline text-sm">
                <span>üëç</span> Visit Facebook Page
            </a>
            <button onclick="shareScore()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 text-sm">
                <span>üì∏</span> Share License
            </button>
            <button onclick="window.location.reload()" class="bg-white hover:bg-gray-200 text-black font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 text-sm">
                <span>üîÑ</span> Try Again
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvOJzCLi4VsQr9IaoHtDlNZ2uo6Vtm0ZA",
            authDomain: "tuktuk-b1020.firebaseapp.com",
            projectId: "tuktuk-b1020",
            storageBucket: "tuktuk-b1020.firebasestorage.app",
            messagingSenderId: "864257502086",
            appId: "1:864257502086:web:f1123aa3b3ed02f17e9a07",
            measurementId: "G-6KFBYXV89B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const FUNNY_NAMES = ["‡∂ö‡∑ê‡∑Ä‡∑î‡∂∏‡∑ä ‡∂ª‡∂¢‡∑è", "‡∂¥‡∑í‡∑É‡∑ä‡∑É‡∑î ‡∂¥‡∑ñ‡∑É‡∑è", "‡∂∂‡∂© ‡∂∏‡∑Ñ‡∂≠‡∑è", "‡∂ö‡∑ú‡∑É‡∑ä ‡∂∏‡∑è‡∂∏‡∑è", "‡∂ß‡∑î‡∂ö‡∑ä ‡∂ö‡∑è‡∂¥‡∑î‡∑Ä‡∑è", "‡∑É‡∂∫‡∑í‡∂Ω‡∂±‡∑ä‡∑É‡∂ª‡∑ä", "‡∑Ä‡∂ö‡∑ä‡∂ö‡∂©", "‡∂á‡∂∏‡∑ä‡∂©‡∂±‡∑ä"];
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('player-name');
        const errorMsg = document.getElementById('name-error');
        const suggestBtn = document.getElementById('suggestion-btn');
        
        const savedName = localStorage.getItem('tukPlayerName');
        if (savedName) {
            nameInput.value = savedName;
            document.getElementById('welcome-msg').classList.remove('hidden');
        }

        suggestBtn.addEventListener('click', () => {
            nameInput.value = suggestBtn.innerText;
            errorMsg.classList.add('hidden');
            suggestBtn.classList.add('hidden');
            nameInput.classList.remove('shake');
        });

        startBtn.addEventListener('click', async () => {
            const inputName = nameInput.value.trim();
            if(!inputName) { alert("‡∂±‡∂∏‡∂ö‡∑ä ‡∂Ø‡∑è‡∂¥‡∂±‡∑ä ‡∂∂‡∂Ç!"); return; }

            document.getElementById('btn-text').classList.add('hidden');
            document.getElementById('btn-loader').classList.remove('hidden');

            // --- AUDIO TRIGGER FIX ---
            // We ensure audio is unlocked on the first button click
            if (bgMusic.paused) {
                bgMusic.play().then(() => {
                    document.getElementById('loading-msg').style.display = 'block';
                    setTimeout(() => document.getElementById('loading-msg').style.display = 'none', 3000);
                }).catch(e => console.log("Audio waiting..."));
            }

            if(inputName === localStorage.getItem('tukPlayerName')) {
                startGameSuccess(inputName);
                return;
            }

            try {
                const docRef = doc(db, "scores", inputName);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    document.getElementById('btn-text').classList.remove('hidden');
                    document.getElementById('btn-loader').classList.add('hidden');
                    const randName = FUNNY_NAMES[Math.floor(Math.random() * FUNNY_NAMES.length)] + "_" + Math.floor(Math.random()*100);
                    errorMsg.innerText = "‡∂í ‡∂±‡∂∏ ‡∑Ä‡∑ô‡∂± ‡∂ë‡∂ö‡∑ô‡∂ö‡∑ä ‡∂Ö‡∂ª‡∂±‡∑ä! ‡∂∏‡∑ö‡∂ö ‡∂ú‡∂∏‡∑î‡∂Ø?";
                    errorMsg.classList.remove('hidden');
                    suggestBtn.innerText = randName;
                    suggestBtn.classList.remove('hidden');
                    nameInput.classList.add('shake');
                    setTimeout(()=>nameInput.classList.remove('shake'), 500);
                } else {
                    localStorage.setItem('tukPlayerName', inputName);
                    startGameSuccess(inputName);
                }
            } catch(e) {
                console.error("Connection error", e);
                localStorage.setItem('tukPlayerName', inputName);
                startGameSuccess(inputName);
            }
        });

        function startGameSuccess(name) { window.startGameInternal(); }

        window.saveScoreToDB = async (name, score) => {
            const status = document.getElementById('upload-status');
            try {
                const docRef = doc(db, "scores", name);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const currentDBScore = docSnap.data().score;
                    if (score > currentDBScore) {
                        await updateDoc(docRef, { score: Math.floor(score), date: new Date() });
                        status.innerText = "New High Score Saved! üöÄ";
                    } else { status.innerText = `High Score Remains: ${currentDBScore} üîí`; }
                } else {
                    await setDoc(docRef, { name: name, score: Math.floor(score), date: new Date() });
                    status.innerText = "Score Saved! ‚úÖ";
                }
                status.classList.add('text-green-400');
                window.loadLeaderboard(); 
            } catch (e) { status.innerText = "Error Saving (Check Internet) ‚ùå"; status.classList.add('text-red-400'); }
        };

        window.loadLeaderboard = async () => {
            const listDiv = document.getElementById('leaderboard-list');
            listDiv.innerHTML = '<p class="text-gray-500 text-xs">Updating...</p>';
            try {
                const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                listDiv.innerHTML = ""; 
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const displayName = data.name ? data.name : doc.id;
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center leaderboard-row bg-gray-900/50 p-1 rounded px-2';
                    row.innerHTML = `<span>#${rank} ${displayName.substring(0,12)}</span> <span>${data.score}</span>`;
                    listDiv.appendChild(row);
                    rank++;
                });
                if(rank === 1) listDiv.innerHTML = '<p class="text-gray-500 text-xs">No scores yet.</p>';
            } catch (e) { listDiv.innerHTML = '<p class="text-red-500 text-xs">Failed to load scores.</p>'; }
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const CONFIG = { laneWidth: 14, startSpeed: 0.6, maxGap: 30, enemySpeed: 0.012 };
        const BUS_NAMES = ["‡∂∏‡∑è‡∂ª ‡∑É‡∑ô‡∂±‡∂ú", "‡∂ö‡∑ê‡∂Ω‡∑ö ‡∂ª‡∂¢‡∑è", "‡∑Ñ‡∑ù‡∂Ω‡∑ä‡∂ß‡∑ä ‡∂±‡∑ë", "‡∂ö‡∑î‡∂©‡∑î ‡∂ë‡∂ö‡∑ä‡∑É‡∑ä‡∂¥‡∑ä‚Äç‡∂ª‡∑É‡∑ä", "‡∂±‡∂∫‡∑í‡∂ß‡∑ä ‡∂ª‡∂∫‡∑í‡∂©‡∂ª‡∑ä", "‡∂Ö‡∑Ä‡∂≠‡∑è‡∂ª‡∑ö", "‡∑É‡∑ú‡∂±‡∑í‡∂ö‡∑ä"];
        const BUS_SHOUTS = ["‡∂Ö‡∂©‡∑ù ‡∂Ö‡∂∫‡∑í‡∂±‡∑ä ‡∂ö‡∂ª‡∂¥‡∂±‡∑ä!", "‡∂¥‡∑è‡∂ª ‡∂∏‡∂ú‡∑ö ‡∂∫‡∂ö‡∑ù!", "‡∂î‡∑Ñ‡∑ú‡∂∏ ‡∂∫‡∂∏‡∂±‡∑ä!", "‡∂≠‡∑ù ‡∂ö‡∑ú‡∑Ñ‡∑ô‡∂Ø ‡∂∫‡∂±‡∑ä‡∂±‡∑ö!", "‡∂¥‡∂Ω‡∂∫‡∂±‡∑ä ‡∂Ö‡∂∫‡∑í‡∂±‡∑ä ‡∑Ä‡∑ô‡∂Ω‡∑è!", "‡∂∏‡∂ú‡∑ô‡∂±‡∑ä ‡∂ö‡∂±‡∑ä‡∂±‡∂Ø ‡∑Ñ‡∂Ø‡∂±‡∑ä‡∂±‡∑ö?"];
        const CRASH_SHOUTS = ["‡∂Ö‡∂∫‡∑í‡∂∫‡∑ù ‡∑É‡∂Ω‡∑ä‡∂Ω‡∑í!", "‡∂ö‡∑ú‡∑Ñ‡∑ô‡∂Ø ‡∂∫‡∂ö‡∑ù ‡∂ú‡∑í‡∂∫‡∑ö!", "‡∑Ä‡∑è‡∑Ñ‡∂±‡∑ö ‡∂â‡∑Ä‡∂ª‡∂∫‡∑í!", "‡∂Ö‡∂∏‡∑ä‡∂∏‡∑ù!", "‡∂ö‡∑ô‡∂Ω ‡∑Ä‡∑î‡∂±‡∑è ‡∂±‡∑ö‡∂Ø?", "‡∑É‡∑ú‡∂ª‡∑í ‡∂©‡∑ú‡∂ß‡∑ä ‡∂ö‡∑ú‡∂∏‡∑ä"];

        // --- AUDIO SYSTEM ---
        // !!! IMPORTANT !!!
        // You MUST upload a file named "audio.mp3" to the same folder as this HTML file.
        const SONG_FILE = "audio.mp3"; 
        
        let bgMusic = new Audio(SONG_FILE);
        bgMusic.loop = true; 
        bgMusic.volume = 1.0; // Max volume
        let isMuted = false;

        // Error handling if file is missing
        bgMusic.onerror = function() {
            alert("‡∑É‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä ‡∑Ñ‡∑ú‡∂∫‡∑è‡∂ú‡∂±‡∑ä‡∂± ‡∂∂‡∑ë! ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö‡∑ö ‡∂±‡∂∏ audio.mp3 ‡∂Ø? ‡∂ë‡∂ö‡∂∏ ‡∑Ü‡∑ù‡∂Ω‡∑ä‡∂©‡∂ª‡∑ä ‡∂ë‡∂ö‡∑ö‡∂Ø ‡∂Ø‡∑ê‡∂∏‡∑ä‡∂∏‡∑ö?");
        };

        window.toggleSound = function() {
            isMuted = !isMuted;
            bgMusic.muted = isMuted;
            const btn = document.getElementById('mute-btn');
            btn.innerText = isMuted ? "üîá" : "üîä";
            btn.style.backgroundColor = isMuted ? "rgba(255,0,0,0.5)" : "rgba(255,255,255,0.2)";
        };

        function stopBusMusic() { bgMusic.pause(); bgMusic.currentTime = 0; }

        let state = { 
            isPlaying: false, score: 0, passengers: 0, gap: 20, speedMultiplier: 1.0, 
            frame: 0, playerName: "Rider", entities: [], 
            playerColor: parseInt(localStorage.getItem('tukColor')) || 0xDC2626,
            playerWadan: localStorage.getItem('tukWadan') || "‡∑Ä‡∂Ø‡∂±‡∑ä ‡∂±‡∑ë",
            isDay: false
        };
        let animationId;

        // Visual Effects
        function showVisualShout(text, type) {
            const container = document.getElementById('shout-container');
            const bubble = document.createElement('div');
            bubble.className = `shout-bubble ${type === 'player' ? 'shout-player' : ''}`;
            bubble.innerText = text;
            if (type !== 'player') {
                const isLeft = Math.random() > 0.5;
                bubble.style.left = isLeft ? Math.random()*10 + 2 + '%' : Math.random()*10 + 80 + '%';
                bubble.style.top = Math.random() * 50 + 10 + '%';
                bubble.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
            }
            container.appendChild(bubble); setTimeout(() => bubble.remove(), 2500); 
        }

        function showPickupAnim() {
            const container = document.getElementById('shout-container');
            const txt = document.createElement('div'); txt.className = 'pickup-anim';
            txt.innerText = "+1 Passenger"; txt.style.left = '50%'; txt.style.top = '60%';
            txt.style.transform = 'translate(-50%, -50%)';
            container.appendChild(txt); setTimeout(()=>txt.remove(), 800);
        }

        // Three.js Setup
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x050505); scene.fog = new THREE.Fog(0x050505, 10, 100);
        const mainCamera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        mainCamera.position.set(0, 6, 14); mainCamera.lookAt(0, 0, -10);
        const mirrorCamera = new THREE.PerspectiveCamera(60, 2.2, 0.1, 1000);
        mirrorCamera.position.set(0, 4, -4); mirrorCamera.lookAt(0, 2, 50);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true; renderer.autoClear = false;
        document.getElementById('game-container').appendChild(renderer.domElement);

        const ambLight = new THREE.AmbientLight(0xffffff, 0.2); scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5); dirLight.position.set(10, 20, 10); dirLight.castShadow = true; scene.add(dirLight);
        const headLight = new THREE.SpotLight(0xffffaa, 1.8); headLight.position.set(0, 3, -1); headLight.target.position.set(0, 0, -30);
        headLight.angle = 0.6; headLight.penumbra = 0.5; headLight.castShadow = true; scene.add(headLight); scene.add(headLight.target);

        function createBox(w, h, d, color, x, y, z, parent) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({ color: color }));
            mesh.position.set(x, y, z); mesh.castShadow = true; if(parent) parent.add(mesh); return mesh;
        }

        function createTextTexture(text, bgColor, txtColor, w, h) {
            const cvs = document.createElement('canvas'); cvs.width=w; cvs.height=h;
            const ctx = cvs.getContext('2d'); 
            if(bgColor) { ctx.fillStyle=bgColor; ctx.fillRect(0,0,w,h); }
            else { ctx.clearRect(0,0,w,h); }
            ctx.fillStyle=txtColor; ctx.font="bold 40px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; 
            ctx.fillText(text, w/2, h/2);
            return new THREE.CanvasTexture(cvs);
        }

        function createWeirdBuilding() {
            const type = Math.floor(Math.random() * 3);
            let geo, mat; const col = Math.random() * 0xffffff;
            if(type === 0) geo = new THREE.CylinderGeometry(0, 4, 15, 4); 
            else if(type === 1) geo = new THREE.TorusKnotGeometry(3, 1, 64, 8); 
            else geo = new THREE.BoxGeometry(4, 20, 4); 
            mat = new THREE.MeshStandardMaterial({ color: col, roughness: 0.3 });
            return new THREE.Mesh(geo, mat);
        }

        function createPrivateBus() {
            const group = new THREE.Group();
            const col = [0x8A2BE2, 0x0000FF, 0xFF1493, 0x00FF00][Math.floor(Math.random()*4)];
            createBox(3.4, 3.8, 10, col, 0, 1.9, 0, group);
            const win = new THREE.Mesh(new THREE.BoxGeometry(3.2, 1.2, 0.2), new THREE.MeshStandardMaterial({color:0x111111}));
            win.position.set(0, 2.6, 5.1); group.add(win);
            const randName = BUS_NAMES[Math.floor(Math.random() * BUS_NAMES.length)];
            const nameMesh = new THREE.Mesh(new THREE.PlaneGeometry(4, 1), new THREE.MeshBasicMaterial({ map: createTextTexture(randName, null, '#FFD700', 256, 64), transparent: true }));
            nameMesh.position.set(0, 4.2, 0); group.add(nameMesh);
            group.userData = { type: 'bus', busName: randName };
            return group;
        }

        let playerTuk;
        function createTuk(color, isHelago, wadanText) {
            const group = new THREE.Group();
            createBox(1.5, 0.6, 2.8, color, 0, 0.6, 0, group); 
            createBox(1.4, 1.4, 1.4, color, 0, 1.4, 0.6, group); 
            createBox(1.3, 1.0, 0.6, color, 0, 1.0, -0.9, group); 
            const roof = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.1, 3.4), new THREE.MeshStandardMaterial({ color: 0x111111 }));
            roof.position.set(0, 2.4, 0.1); group.add(roof);
            if(isHelago) {
                const sign = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.5, 0.1), new THREE.MeshBasicMaterial({map: createTextTexture('HELAGO', '#00A651', 'white', 128, 64)}));
                sign.position.set(0, 2.8, 0); group.add(sign);
                const glow = new THREE.PointLight(0x00ff00, 1, 10); glow.position.set(0, 2, 0); group.add(glow);
            } else if (wadanText && wadanText !== "‡∑Ä‡∂Ø‡∂±‡∑ä ‡∂±‡∑ë") {
                const stickerGeo = new THREE.PlaneGeometry(1.6, 0.5); 
                const stickerMat = new THREE.MeshBasicMaterial({ 
                    map: createTextTexture(wadanText, 'white', 'black', 256, 64), 
                    transparent: true,
                    side: THREE.DoubleSide
                });
                const sticker = new THREE.Mesh(stickerGeo, stickerMat);
                sticker.position.set(0, 1.5, 1.35); 
                group.add(sticker);
            }
            return group;
        }

        playerTuk = createTuk(state.playerColor, false, state.playerWadan); scene.add(playerTuk);
        const enemyTuk = createTuk(0x00A651, true, null); scene.add(enemyTuk);

        const road = new THREE.Mesh(new THREE.PlaneGeometry(30, 2000), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        road.rotation.x = -Math.PI/2; road.position.z = -500; road.receiveShadow = true; scene.add(road);
        const lines = [];
        for(let i=0; i<40; i++) {
            const l = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 10), new THREE.MeshBasicMaterial({ color: 0xffffff }));
            l.rotation.x = -Math.PI/2; l.position.set(0, 0.05, -i*25); scene.add(l); lines.push(l);
        }

        let targetX = 0;

        window.toggleGarage = function() {
            const m = document.getElementById('garage-modal');
            const totalC = localStorage.getItem('tukCoins') || 0;
            document.getElementById('total-coins').innerText = totalC;
            m.classList.toggle('hidden');
        };

        window.selectColor = function(color, cost) {
            let totalC = parseInt(localStorage.getItem('tukCoins') || 0);
            if(totalC >= cost) {
                if(cost > 0) {
                    totalC -= cost; localStorage.setItem('tukCoins', totalC);
                    document.getElementById('total-coins').innerText = totalC;
                }
                state.playerColor = color; localStorage.setItem('tukColor', color);
                scene.remove(playerTuk); playerTuk = createTuk(color, false, state.playerWadan); scene.add(playerTuk);
                alert("‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂∫ ‡∂∏‡∑è‡∂ª‡∑î ‡∂ö‡∑Ö‡∑è!");
            } else { alert("‡∂∏‡∂ú‡∑ì‡∂±‡∑ä ‡∂∏‡∂Ø‡∑í!"); }
        };

        window.selectWadan = function(text, cost) {
            let totalC = parseInt(localStorage.getItem('tukCoins') || 0);
            if(totalC >= cost) {
                if(cost > 0) {
                    totalC -= cost; localStorage.setItem('tukCoins', totalC);
                    document.getElementById('total-coins').innerText = totalC;
                }
                state.playerWadan = text; localStorage.setItem('tukWadan', text);
                scene.remove(playerTuk); playerTuk = createTuk(state.playerColor, false, text); scene.add(playerTuk);
                alert("‡∑Ä‡∂Ø‡∂±‡∑ä ‡∂ú‡∑ê‡∑Ñ‡∑î‡∑Ä‡∑è: " + text);
            } else { alert("‡∂∏‡∂ú‡∑ì‡∂±‡∑ä ‡∂∏‡∂Ø‡∑í!"); }
        };

        window.buyCustomWadan = function() {
            const input = document.getElementById('custom-wadan-input');
            const text = input.value.trim();
            const cost = 300;
            
            if(!text) { alert("‡∑Ä‡∂Ø‡∂±‡∂ö‡∑ä ‡∂ú‡∑Ñ‡∂±‡∑ä‡∂±!"); return; }
            if(text.length > 10) { alert("‡∑Ä‡∂†‡∂± ‡∑Ä‡∑ê‡∂©‡∑í! ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 10‡∂ß ‡∂Ö‡∂©‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂Ø‡∑è‡∂±‡∑ä‡∂±."); return; }

            let totalC = parseInt(localStorage.getItem('tukCoins') || 0);
            if(totalC >= cost) {
                totalC -= cost; localStorage.setItem('tukCoins', totalC);
                document.getElementById('total-coins').innerText = totalC;
                
                state.playerWadan = text; 
                localStorage.setItem('tukWadan', text);
                
                scene.remove(playerTuk); 
                playerTuk = createTuk(state.playerColor, false, text); 
                scene.add(playerTuk);
                
                alert("custom ‡∑Ä‡∂Ø‡∂±‡∂ö‡∑ä ‡∂ú‡∑ê‡∑Ñ‡∑î‡∑Ä‡∑è: " + text);
                input.value = "";
            } else {
                alert("‡∂∏‡∂ú‡∑ì‡∂±‡∑ä ‡∂∏‡∂Ø‡∑í! ‡∂≠‡∑Ä 300‡∂ö‡∑ä ‡∂ï‡∂±.");
            }
        };

        window.startGameInternal = function() {
            state.playerName = document.getElementById('player-name').value || "Rider";
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').style.display = 'flex';
            state.score = 0; state.passengers = 0; state.gap = 20; state.frame = 0;
            state.entities.forEach(e => scene.remove(e.mesh)); state.entities = [];
            state.isDay = false; 
            scene.background.setHex(0x050505); scene.fog.color.setHex(0x050505);
            state.isPlaying = true; 
            if(bgMusic.paused && !isMuted) { bgMusic.play(); }
            animate();
        };

        function showSideWarning(text) {
            const container = document.getElementById('warning-container');
            const alert = document.createElement('div'); alert.className = 'bus-alert'; alert.innerHTML = `‚ö†Ô∏è ${text}`;
            container.appendChild(alert); setTimeout(() => { alert.style.opacity = '0'; setTimeout(() => alert.remove(), 300); }, 2000);
        }

        function spawnEntity() {
            const busChance = state.score > 150 ? 0.85 : 1.1; const rand = Math.random();
            const x = (Math.random() - 0.5) * CONFIG.laneWidth; const z = -120 - Math.random() * 20;
            let mesh, isPassenger=false, isBus=false, isRock=false, isScenery=false;

            if(state.isDay && Math.random() < 0.15) {
                isScenery = true; mesh = createWeirdBuilding();
                const sideX = (Math.random() > 0.5 ? 1 : -1) * (15 + Math.random() * 15);
                mesh.position.set(sideX, 0, z);
            } else {
                if (rand < 0.45) {
                    isPassenger = true;
                    const g = new THREE.Group();
                    const b = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,1.2), new THREE.MeshStandardMaterial({color:0x3B82F6})); b.position.y=0.6;
                    const h = new THREE.Mesh(new THREE.SphereGeometry(0.25), new THREE.MeshStandardMaterial({color:0xffccaa})); h.position.y=1.3;
                    g.add(b); g.add(h); mesh = g; mesh.position.set(x, 0, z);
                } else if (rand > busChance) {
                    isBus = true; mesh = createPrivateBus(); showSideWarning(mesh.userData.busName); mesh.position.set(x, 0, z);
                    if(Math.random() > 0.6) showVisualShout(BUS_SHOUTS[Math.floor(Math.random() * BUS_SHOUTS.length)], 'enemy');
                } else {
                    isRock = true; mesh = new THREE.Mesh(new THREE.DodecahedronGeometry(1.0), new THREE.MeshStandardMaterial({color:0x555555})); 
                    mesh.position.set(x, 1.0, z);
                }
            }
            mesh.castShadow = true; scene.add(mesh);
            state.entities.push({ mesh, isPassenger, isBus, isRock, isScenery, isHit: false, velocity: {x:0,y:0,z:0} });
        }

        function getBadge(score) {
            if (score < 500) return "‡∂±‡∑í‡∂ö‡∂∏‡∑ä‡∂∏ ‡∂á‡∂´‡∂∫‡∂ö‡∑ä üî©";
            if (score < 1500) return "‡∂¥‡∑è‡∂ª‡∑ä‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ö ‡∂†‡∂´‡∑ä‡∂©‡∑í‡∂∫‡∑è üòé";
            if (score < 3000) return "‡∂¥‡∑í‡∑É‡∑ä‡∑É‡∑î ‡∂©‡∑ä‚Äç‡∂ª‡∂∫‡∑í‡∑Ä‡∂ª‡∑ä ü§™";
            return "‡∂∏‡∑Ñ ‡∑Ä‡∑í‡∂ö‡∑è‡∂ª‡∂∫‡∂ö‡∑ä üëëüî•";
        }

        window.shareScore = function() {
            const text = `Tuk Rush ‡∂ë‡∂ö‡∑ö ‡∂∏‡∂ú‡∑ö ‡∂ª‡∑ë‡∂±‡∑ä‡∂ö‡∑ä ‡∂ë‡∂ö: "${getBadge(Math.floor(state.score))}"! Score: ${Math.floor(state.score)}. ‡∑Ä‡∂ª‡∑ô‡∂±‡∑ä ‡∂ª‡∑ö‡∑É‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä!`;
            if (navigator.share) navigator.share({ title: 'Tuk Rush License', text: text, url: window.location.href });
            else { alert("Screenshot ‡∂ú‡∑Ñ‡∂Ω‡∑è ‡∂∫‡∑è‡∂Ω‡∑î‡∑Ä‡∂±‡∑ä‡∂ß ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±! (Link Copied)"); }
        };

        function gameOver() {
            state.isPlaying = false; cancelAnimationFrame(animationId);
            stopBusMusic(); 
            document.getElementById('game-ui').classList.add('hidden');
            const goScreen = document.getElementById('game-over-screen');
            goScreen.classList.remove('hidden'); goScreen.style.display = 'flex';
            showVisualShout(CRASH_SHOUTS[Math.floor(Math.random() * CRASH_SHOUTS.length)], 'player');
            let currentCoins = parseInt(localStorage.getItem('tukCoins') || 0);
            localStorage.setItem('tukCoins', currentCoins + state.passengers);
            const finalScore = Math.floor(state.score);
            document.getElementById('card-name').innerText = state.playerName;
            document.getElementById('card-wadan').innerText = state.playerWadan;
            document.getElementById('final-score').innerText = finalScore;
            document.getElementById('funny-badge').innerText = getBadge(state.score);
            if(window.saveScoreToDB) window.saveScoreToDB(state.playerName, finalScore);
        }

        function animate() {
            if (!state.isPlaying) return;
            animationId = requestAnimationFrame(animate); state.frame++;
            renderer.clear();

            state.speedMultiplier = 1 + (state.score / 5000);
            const currentSpeed = CONFIG.startSpeed * state.speedMultiplier;

            const cycle = Math.floor(state.score / 5000);
            const isDayNow = (cycle % 2 !== 0);
            if (state.isDay !== isDayNow) {
                state.isDay = isDayNow;
                const timeIcon = document.getElementById('time-indicator');
                if (isDayNow) {
                    scene.background.setHex(0x87CEEB); scene.fog.color.setHex(0x87CEEB);
                    dirLight.intensity = 1.0; timeIcon.innerText = "‚òÄÔ∏è";
                } else {
                    scene.background.setHex(0x050505); scene.fog.color.setHex(0x050505);
                    dirLight.intensity = 0.5; timeIcon.innerText = "üåô";
                }
            }

            playerTuk.position.x += (targetX - playerTuk.position.x) * 0.15;
            playerTuk.rotation.z = (playerTuk.position.x - targetX) * 0.08; 
            playerTuk.rotation.y = -(playerTuk.position.x - targetX) * 0.05; 
            headLight.position.x = playerTuk.position.x; headLight.target.position.x = playerTuk.position.x * 3;

            enemyTuk.position.z = state.gap; 
            enemyTuk.position.x += (playerTuk.position.x - enemyTuk.position.x) * 0.05;

            const spawnRate = Math.max(20, 60 - Math.floor(state.score/150));
            if(state.frame % spawnRate === 0) spawnEntity();

            for (let i = 0; i < state.entities.length; i++) {
                const ent = state.entities[i];
                if(ent.isBus) {
                    for(let j=0; j<state.entities.length; j++) {
                        const target = state.entities[j];
                        if((target.isPassenger || target.isRock) && !target.isHit && !target.isScenery) {
                            const dx = Math.abs(ent.mesh.position.x - target.mesh.position.x);
                            const dz = Math.abs(ent.mesh.position.z - target.mesh.position.z);
                            if(dz < 4.0 && dx < 2.5) { 
                                target.isHit = true; target.velocity = { x: (Math.random() - 0.5) * 2.5, y: 1.8, z: 0 };
                            }
                        }
                    }
                }
            }

            for (let i = state.entities.length - 1; i >= 0; i--) {
                const ent = state.entities[i];
                let speed = currentSpeed; if(ent.isBus) speed *= 1.5; 
                if(ent.isHit) {
                    ent.mesh.position.x += ent.velocity.x; ent.mesh.position.y += ent.velocity.y;
                    ent.mesh.rotation.z += 0.5; ent.mesh.rotation.x += 0.2; ent.velocity.y -= 0.1; 
                } else { ent.mesh.position.z += speed; }
                
                if (ent.isScenery) {
                    if(ent.mesh.position.z > 30) { scene.remove(ent.mesh); state.entities.splice(i, 1); }
                    continue;
                }

                const dx = Math.abs(ent.mesh.position.x - playerTuk.position.x);
                const dz = Math.abs(ent.mesh.position.z - playerTuk.position.z);

                if (dz < 2.5 && dx < 2.2 && !ent.isHit) {
                    if (ent.isPassenger) {
                        state.score += 100; state.passengers++; showPickupAnim();
                        state.gap += 8; if(state.gap>CONFIG.maxGap) state.gap=CONFIG.maxGap;
                        scene.remove(ent.mesh); state.entities.splice(i, 1);
                    } else {
                        if(ent.isBus) state.gap = -10; else { state.gap -= 8; state.score -= 50; }
                        scene.remove(ent.mesh); state.entities.splice(i, 1);
                        mainCamera.position.x = (Math.random()-0.5)*1; setTimeout(()=>mainCamera.position.x=0, 100);
                    }
                } else if (ent.mesh.position.z > 30 || ent.mesh.position.y < -5) { 
                    scene.remove(ent.mesh); state.entities.splice(i, 1); 
                }
            }

            lines.forEach(l => { l.position.z += currentSpeed; if(l.position.z > 20) l.position.z -= 1000; });
            state.gap -= CONFIG.enemySpeed * state.speedMultiplier; state.score += 0.5;

            document.getElementById('score-display').innerText = Math.floor(state.score);
            document.getElementById('passenger-count').innerText = state.passengers;
            if(state.gap < 8) document.getElementById('mirror-alert').classList.remove('hidden');
            else document.getElementById('mirror-alert').classList.add('hidden');
            if(state.gap <= 2) gameOver();

            renderer.setScissorTest(false); renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
            renderer.render(scene, mainCamera);

            const mirrorBox = document.getElementById('mirror-box');
            if (mirrorBox) {
                const rect = mirrorBox.getBoundingClientRect();
                const w = rect.width; const h = rect.height; const l = rect.left; const b = window.innerHeight - rect.bottom; 
                renderer.setScissorTest(true); renderer.setScissor(l, b, w, h); renderer.setViewport(l, b, w, h);
                mirrorCamera.position.x = playerTuk.position.x; mirrorCamera.lookAt(enemyTuk.position.x, 2, enemyTuk.position.z);
                renderer.render(scene, mirrorCamera);
            }
        }
        
        window.addEventListener('touchmove', (e)=>{ if(state.isPlaying) targetX=(e.touches[0].clientX/window.innerWidth*CONFIG.laneWidth)-(CONFIG.laneWidth/2); }, {passive:false});
        window.addEventListener('mousemove', (e)=>{ if(state.isPlaying) targetX=(e.clientX/window.innerWidth*CONFIG.laneWidth)-(CONFIG.laneWidth/2); });
        window.addEventListener('resize', ()=>{ mainCamera.aspect=window.innerWidth/window.innerHeight; mainCamera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
    </html>
